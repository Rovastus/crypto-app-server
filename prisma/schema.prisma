generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_WITH_SCHEMA")
}

model Portpholio {
  id                 BigInt               @id @default(autoincrement()) @db.BigInt
  name               String               @unique
  taxMethod          TaxMethod
  fiat               Fiat
  exports            Export[]
  cryptoCoinInWallet CryptoCoinInWallet[]
}

model Export {
  id           BigInt        @id @default(autoincrement()) @db.BigInt
  name         String        @unique
  jsonData     String
  portpholioId BigInt
  portpholio   Portpholio    @relation(fields: [portpholioId], references: [id])
  deposit      Deposit[]
  earn         Earn[]
  transaction  Transaction[]
  withdraw     Withdraw[]
}

model CryptoCoinInWallet {
  id                        BigInt                      @id @default(autoincrement()) @db.BigInt
  time                      DateTime
  amount                    Decimal                     @db.Decimal(65, 8)
  amountCoin                String
  remainAmount              Decimal                     @db.Decimal(65, 8)
  expensesInFiat            Decimal                     @db.Decimal(65, 8)
  portpholioId              BigInt
  portpholio                Portpholio                  @relation(fields: [portpholioId], references: [id])
  earn                      Earn?
  transaction               Transaction?
  transactionExpensesDetail TransactionExpensesDetail[]
}

model Deposit {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  time       DateTime
  amount     Decimal  @db.Decimal(65, 8)
  amountCoin String
  exportId   BigInt
  export     Export   @relation(fields: [exportId], references: [id])
}

model Withdraw {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  time       DateTime
  amount     Decimal  @db.Decimal(65, 8)
  amountCoin String
  exportId   BigInt
  export     Export   @relation(fields: [exportId], references: [id])
}

model Transaction {
  id                   BigInt                @id @default(autoincrement()) @db.BigInt
  time                 DateTime
  buy                  Decimal               @db.Decimal(65, 8)
  buyCoin              String
  price                Decimal               @db.Decimal(65, 8)
  priceCoin            String
  fee                  Decimal               @db.Decimal(65, 8)
  feeCoin              String
  exportId             BigInt
  export               Export                @relation(fields: [exportId], references: [id])
  cryptoCoinInWalletId BigInt
  cryptoCoinInWallet   CryptoCoinInWallet    @relation(fields: [cryptoCoinInWalletId], references: [id])
  transactionTaxEvent  TransactionTaxEvent[]
}

model TransactionTaxEvent {
  id                        BigInt                      @id @default(autoincrement()) @db.BigInt
  type                      TransactionTaxEventType
  gainInFiat                Decimal                     @db.Decimal(65, 8)
  expensesInFiat            Decimal                     @db.Decimal(65, 8)
  transactionId             BigInt
  transaction               Transaction                 @relation(fields: [transactionId], references: [id])
  transactionExpensesDetail TransactionExpensesDetail[]
}

model TransactionExpensesDetail {
  id                    BigInt              @id @default(autoincrement()) @db.BigInt
  amount                Decimal             @db.Decimal(65, 8)
  expensesInFiat        Decimal             @db.Decimal(65, 8)
  cryptoCoinInWalletId  BigInt
  cryptoCoinInWallet    CryptoCoinInWallet  @relation(fields: [cryptoCoinInWalletId], references: [id])
  transactionTaxEventId BigInt
  transactionTaxEvent   TransactionTaxEvent @relation(fields: [transactionTaxEventId], references: [id])
}

model Earn {
  id                   BigInt             @id @default(autoincrement()) @db.BigInt
  time                 DateTime
  amount               Decimal            @db.Decimal(65, 8)
  amountCoin           String
  exportId             BigInt
  export               Export             @relation(fields: [exportId], references: [id])
  earnTaxEventId       BigInt
  earnTaxEvent         EarnTaxEvent       @relation(fields: [earnTaxEventId], references: [id])
  cryptoCoinInWalletId BigInt
  cryptoCoinInWallet   CryptoCoinInWallet @relation(fields: [cryptoCoinInWalletId], references: [id])
}

model EarnTaxEvent {
  id         BigInt  @id @default(autoincrement()) @db.BigInt
  gainInFiat Decimal @db.Decimal(65, 8)
  earn       Earn?
}

model CoinPairPriceHistory {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  time       DateTime
  price      Decimal  @db.Decimal(65, 8)
  url        String
  coinPairId BigInt
  coinPair   CoinPair @relation(fields: [coinPairId], references: [id])

  @@unique([time, coinPairId], name: "time_coinPairId_unique")
}

model CoinPair {
  id               BigInt                 @id @default(autoincrement()) @db.BigInt
  pair             String                 @unique
  pairPriceHistory CoinPairPriceHistory[]
}

enum TaxMethod {
  FIFO
  AVCO
}

enum Fiat {
  EUR
}

enum TransactionTaxEventType {
  FEE
  BUY
}
